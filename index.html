<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Control Roster</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Supabase JS CDN -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <style>
    /* ===== Global layout ===== */
    html, body {
      width: 100%;
      max-width: 100%;
      margin: 0;
      padding: 0;
      overflow-x: hidden;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #d8dce3; /* darker grey background */
      color: #0f172a;      /* deep slate/navy text */
    }

    header {
      padding: 0.75rem 1rem;
      background: #f5f6f8;
      border-bottom: 1px solid #b8bfc9;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    header h1 {
      margin: 0;
      font-size: 1.2rem;
      font-weight: 600;
      color: #0f172a;
    }
    header span {
      font-size: 0.85rem;
      color: #475569;
    }

    .container {
      padding: 0.75rem 1rem;
      max-width: 100%;
      width: 100%;
      margin: 0;
    }

    .card {
      background: #f2f3f5;
      border-radius: 0.75rem;
      border: 1px solid #b8bfc9;
      padding: 1rem 1.25rem;
      margin-bottom: 1rem;
      box-shadow: 0 1px 2px rgba(15, 23, 42, 0.08);
    }
    .card h2 {
      margin: 0 0 0.5rem;
      font-size: 1rem;
      color: #0f172a;
    }
    .muted {
      color: #475569;
      font-size: 0.8rem;
    }

    /* ===== Buttons ===== */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      padding: 0.45rem 0.8rem;
      border-radius: 999px;
      border: 1px solid #b8bfc9;
      background: #e2e6eb;
      color: #0f172a;
      font-size: 0.8rem;
      cursor: pointer;
      transition: background 0.12s ease, border-color 0.12s ease, box-shadow 0.12s ease;
    }
    .btn:hover {
      background: #d5d9e2;
      border-color: #aeb6c4;
      box-shadow: 0 1px 2px rgba(15, 23, 42, 0.12);
    }
    .btn-primary {
      border-color: #2563eb;
      background: #3b82f6;
      color: #ffffff;
    }
    .btn-primary:hover {
      background: #2563eb;
      border-color: #1d4ed8;
    }
    .btn-danger {
      border-color: #dc2626;
      background: #ef4444;
      color: #ffffff;
    }
    .btn-sm {
      padding: 0.25rem 0.6rem;
      font-size: 0.7rem;
    }

    /* ===== Inputs & selects ===== */
    input, select {
      background: #f3f4f6;
      border-radius: 0.4rem;
      border: 1px solid #b8bfc9;
      color: #0f172a;
      padding: 0.35rem 0.55rem;
      font-size: 0.8rem;
    }
    input::placeholder {
      color: #9ca3af;
    }
    input:focus, select:focus {
      outline: 2px solid #3b82f6;
      outline-offset: 1px;
      border-color: #3b82f6;
    }

    /* ===== Table / roster area ===== */
    table {
      border-collapse: collapse;
      width: 100%;
      font-size: 0.8rem;
      background: #f8f9fa;
    }
    th, td {
      border: 1px solid #b8bfc9;
      padding: 0.3rem 0.4rem;
      text-align: center;
    }
    thead {
      background: #e5e7eb;
      position: sticky;
      top: 0;
      z-index: 2;
    }
    thead th {
      font-weight: 600;
      color: #0f172a;
    }

    /* Roster grid: full-width, mostly vertical scrolling */
    .roster-grid {
      max-width: 100%;
      width: 100%;
      max-height: 70vh;
      overflow-y: auto;
      overflow-x: auto; /* unavoidable on very small screens, but fine on desktops */
      margin-top: 0.5rem;
      background: #eef0f3;
      border-radius: 0.5rem;
      border: 1px solid #c4c9d2;
      padding: 0.25rem;
    }

    /* ===== Shift cell layout ===== */
    .shift-cell-wrap {
      display: flex;
      align-items: center;
      gap: 0.2rem;
    }
    .shift-input {
      flex: 1;
      min-width: 0;
      background: #ffffff;
    }
    .shift-preset {
      font-size: 0.7rem;
      padding-inline: 0.3rem;
      background: #e2e6eb;
    }

    /* RDW pill */
    .rdw-toggle {
      display: none;
      border-radius: 999px;
      border: 1px solid #cbd5e1;
      padding: 0.1rem 0.4rem;
      font-size: 0.65rem;
      background: #f3f4f6;
      color: #475569;
      cursor: pointer;
      white-space: nowrap;
    }
    .shift-cell-wrap:focus-within .rdw-toggle {
      display: inline-flex;
    }
    .rdw-toggle.rdw-active {
      display: inline-flex;
      background: #2c2cd9;
      color: #ffffff;
      font-weight: 700;
      border-color: #2c2cd9;
    }

    /* ===== Conditional formatting-ish classes ===== */

    /* Day shifts: pastel orange */
    .shift-day {
      background: #f1a983;
      color: #7c2d12;
    }

    /* Night shifts: pastel blue */
    .shift-night {
      background: #4d93d9;
      color: #1e3a8a;
    }

    /* Spare: pastel pink/purple */
    .shift-spare {
      background: #d86dcd;
      color: #701a75;
    }

    /* N/A / OOU: pastel yellow */
    .shift-oo {
      background: #fef9c3;
      color: #854d0e;
    }

    /* Annual leave: red, strikethrough */
    .shift-al {
      background: #fee2e2;
      color: #991b1b;
      text-decoration: line-through;
    }

    /* Comp leave: orange, strikethrough */
    .shift-cl {
      background: #ffedd5;
      color: #9a3412;
      text-decoration: line-through;
    }

    /* Sick: green, strikethrough */
    .shift-sick {
      background: #ffffff;
      color: #166534;
      text-decoration: line-through;
    }

    /* Rest day */
    .shift-rd {
      background: #f3f4f6;
      color: #6b7280;
      font-style: italic;
    }

    /* B.O – same as A/L through classifyShift; extra emphasis optional */
    .shift-bo {
      color: #b91c1c;
      font-weight: 600;
    }

    /* ROP tags: bold */
    .shift-rop {
      font-weight: 700;
    }

    /* Tags and status pills */
    .tag {
      display: inline-flex;
      align-items: center;
      border-radius: 999px;
      padding: 0.15rem 0.4rem;
      font-size: 0.7rem;
      border: 1px solid #cbd2dd;
      color: #4b5563;
      background: #eef0f3;
    }
    .status-pill {
      padding: 0.15rem 0.5rem;
      border-radius: 999px;
      font-size: 0.7rem;
      border: 1px solid #b8bfc9;
      background: #f2f3f5;
    }
    .status-draft {
      border-color: #f59e0b;
      color: #92400e;
      background: #fffbeb;
    }
    .status-published {
      border-color: #22c55e;
      color: #15803d;
      background: #ecfdf3;
    }

    /* Layout helpers */
    .flex {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      flex-wrap: wrap;
    }
    .flex-between {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
      flex-wrap: wrap;
    }
    .mt-1 { margin-top: 0.25rem; }
    .mt-2 { margin-top: 0.5rem; }
    .mt-3 { margin-top: 0.75rem; }
    .mb-1 { margin-bottom: 0.25rem; }
    .mb-2 { margin-bottom: 0.5rem; }
    .w-100 { width: 100%; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <header>
    <div>
      <h1>Control Roster</h1>
      <span>GitHub-hosted • Supabase-backed • Excel finally retired</span>
    </div>
    <div class="flex">
      <span id="user-info" class="muted">Not signed in</span>
      <button id="btn-signout" class="btn btn-sm hidden">Sign out</button>
    </div>
  </header>

  <div class="container">

    <!-- Auth card -->
    <div id="auth-card" class="card">
      <h2>Sign in</h2>
      <p class="muted">Use your Supabase email/password account to manage rosters.</p>
      <form id="auth-form" class="flex mt-2">
        <input type="email" id="auth-email" placeholder="Email" required />
        <input type="password" id="auth-password" placeholder="Password" required />
        <button type="submit" class="btn btn-primary">Sign in</button>
      </form>
      <div class="mt-2">
        <button id="btn-viewer" class="btn btn-sm">
          View roster read-only
        </button>
      </div>
      <p id="auth-error" class="muted mt-2"></p>
    </div>

    <!-- Main app -->
    <div id="app" class="hidden">

      <!-- Week list -->
      <div class="card">
        <div class="flex-between">
          <div>
            <h2>Roster weeks</h2>
            <p class="muted">Draft & published rosters, one record per week ending.</p>
          </div>
          <div class="flex">
            <input type="date" id="new-week-date" />
            <select id="new-week-template">
              <option value="">Template…</option>
            </select>
            <button id="btn-create-week" class="btn btn-primary">New draft from template</button>
          </div>
        </div>
        <div class="mt-2">
          <table id="weeks-table">
            <thead>
              <tr>
                <th>Week ending</th>
                <th>Label</th>
                <th>Status</th>
                <th>Template</th>
                <th>Created by</th>
                <th>Published at</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="weeks-tbody"></tbody>
          </table>
        </div>
      </div>

      <!-- Roster editor -->
      <div id="editor-card" class="card hidden">
        <div class="flex-between">
          <div>
            <h2 id="editor-title">Week editor</h2>
            <p id="editor-subtitle" class="muted"></p>
          </div>
          <div class="flex">
            <span id="editor-status-pill" class="status-pill"></span>
            <button id="btn-save-week" class="btn btn-primary btn-sm">Save draft</button>
            <button id="btn-publish-week" class="btn btn-sm">Publish</button>
          </div>
        </div>
        <div class="mt-2 roster-grid" id="roster-grid"></div>
      </div>
    </div>
  </div>

  <script>
    // ===== CONFIG =====
    const SUPABASE_URL = "https://ywvbxfitzsuyhvxcdnth.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl3dmJ4Zml0enN1eWh2eGNkbnRoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMyMzAwNTMsImV4cCI6MjA3ODgwNjA1M30.d-yN2C599j4BInhVt6QKDImhGGmiidIlOjuxAAnjVCM";

    const { createClient } = window.supabase;
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let currentUser = null;
    let currentProfile = null;
    let currentWeek = null; // full row from roster_weeks
    let isPublicViewer = false; // viewer mode flag

    // ===== Date formatting helper (UK) =====
    function formatUK(dateStr) {
      if (!dateStr) return "";
      const d = new Date(dateStr);
      if (isNaN(d)) return dateStr;
      const day = String(d.getDate()).padStart(2, "0");
      const month = String(d.getMonth() + 1).padStart(2, "0");
      const year = d.getFullYear();
      return `${day}/${month}/${year}`;
    }

    // ===== AUTH =====
    const authCard = document.getElementById("auth-card");
    const appEl = document.getElementById("app");
    const authForm = document.getElementById("auth-form");
    const authEmail = document.getElementById("auth-email");
    const authPassword = document.getElementById("auth-password");
    const authError = document.getElementById("auth-error");
    const userInfo = document.getElementById("user-info");
    const btnSignout = document.getElementById("btn-signout");
    const btnViewer = document.getElementById("btn-viewer");

    const newWeekTemplateSelect = document.getElementById("new-week-template");
    const weeksTbody = document.getElementById("weeks-tbody");
    const newWeekDate = document.getElementById("new-week-date");
    const btnCreateWeek = document.getElementById("btn-create-week");

    const editorCard = document.getElementById("editor-card");
    const editorTitle = document.getElementById("editor-title");
    const editorSubtitle = document.getElementById("editor-subtitle");
    const editorStatusPill = document.getElementById("editor-status-pill");
    const rosterGrid = document.getElementById("roster-grid");
    const btnSaveWeek = document.getElementById("btn-save-week");
    const btnPublishWeek = document.getElementById("btn-publish-week");

    authForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      authError.textContent = "";
      const email = authEmail.value.trim();
      const password = authPassword.value;

      const { data, error } = await supabase.auth.signInWithPassword({ email, password });
      if (error) {
        authError.textContent = error.message;
        return;
      }
      currentUser = data.user;
      isPublicViewer = false;
      await loadProfile();
      await postLoginInit();
    });

    btnSignout.addEventListener("click", async () => {
      await supabase.auth.signOut();
      currentUser = null;
      currentProfile = null;
      currentWeek = null;
      isPublicViewer = false;
      userInfo.textContent = "Not signed in";
      btnSignout.classList.add("hidden");
      authCard.classList.remove("hidden");
      appEl.classList.add("hidden");
      editorCard.classList.add("hidden");
    });

    btnViewer.addEventListener("click", async (e) => {
      e.preventDefault();
      isPublicViewer = true;
      currentUser = null;
      currentProfile = { full_name: "Public viewer", role: "viewer" };

      userInfo.textContent = "Public viewer • read-only";
      btnSignout.classList.add("hidden");
      authCard.classList.add("hidden");
      appEl.classList.remove("hidden");

      newWeekDate.disabled = true;
      newWeekTemplateSelect.disabled = true;
      btnCreateWeek.disabled = true;

      await loadTemplates();
      await loadWeeks();
    });

    async function loadProfile() {
      if (!currentUser) return;
      const { data, error } = await supabase
        .from("profiles")
        .select("*")
        .eq("id", currentUser.id)
        .single();

      if (!error) currentProfile = data;
    }

    async function postLoginInit() {
      const role = currentProfile?.role || "viewer";

      userInfo.textContent = currentProfile
        ? `${currentProfile.full_name || currentUser.email} • ${currentProfile.role}`
        : currentUser.email;

      isPublicViewer = false;
      btnSignout.classList.remove("hidden");
      authCard.classList.add("hidden");
      appEl.classList.remove("hidden");

      newWeekDate.disabled = false;
      newWeekTemplateSelect.disabled = false;
      btnCreateWeek.disabled = !(role === "editor" || role === "admin");

      await loadTemplates();
      await loadWeeks();
    }

    (async function init() {
      const { data } = await supabase.auth.getSession();
      if (data.session) {
        currentUser = data.session.user;
        await loadProfile();
        await postLoginInit();
      }
    })();

    async function loadTemplates() {
      const { data, error } = await supabase
        .from("roster_templates")
        .select("id, name, code")
        .order("code", { ascending: true });

      if (error) {
        console.error("loadTemplates error", error);
        return;
      }

      newWeekTemplateSelect.innerHTML = '<option value="">Template…</option>';
      for (const t of data) {
        const opt = document.createElement("option");
        opt.value = t.id;
        opt.textContent = `${t.code} – ${t.name}`;
        newWeekTemplateSelect.appendChild(opt);
      }
    }

    btnCreateWeek.addEventListener("click", async () => {
      const role = currentProfile?.role || "viewer";
      if (isPublicViewer || !(role === "editor" || role === "admin")) {
        alert("You do not have permission to create weeks.");
        return;
      }

      const dateStr = newWeekDate.value; // ISO yyyy-mm-dd
      const templateId = newWeekTemplateSelect.value;
      if (!dateStr || !templateId) {
        alert("Pick a week ending date and a template.");
        return;
      }

      const { data: tmpl, error: tmplErr } = await supabase
        .from("roster_templates")
        .select("id, name, code, structure")
        .eq("id", templateId)
        .single();

      if (tmplErr) {
        console.error(tmplErr);
        alert("Unable to load template.");
        return;
      }

      const label = `Week - Ending ${formatUK(dateStr)}`;
      const payload = {
        week_ending: dateStr,
        label,
        status: "draft",
        template_id: tmpl.id,
        data: tmpl.structure,
      };

      const { data, error } = await supabase
        .from("roster_weeks")
        .insert(payload)
        .select("*")
        .single();

      if (error) {
        console.error(error);
        alert("Error creating week.");
        return;
      }

      await loadWeeks();
      await openWeek(data);
    });

    async function loadWeeks() {
      const { data, error } = await supabase
        .from("roster_weeks")
        .select("id, week_ending, label, status, template_id, created_at, published_at, created_by, roster_templates(name, code)")
        .order("week_ending", { ascending: false });

      if (error) {
        console.error("loadWeeks error", error);
        return;
      }

      weeksTbody.innerHTML = "";
      for (const w of data) {
        const tr = document.createElement("tr");
        const tmplLabel = w.roster_templates
          ? `${w.roster_templates.code} – ${w.roster_templates.name}`
          : "N/A";

        tr.innerHTML = `
          <td>${formatUK(w.week_ending)}</td>
          <td>${w.label || ""}</td>
          <td>
            <span class="status-pill ${w.status === "published" ? "status-published" : "status-draft"}">
              ${w.status}
            </span>
          </td>
          <td>${tmplLabel}</td>
          <td>${w.created_by || ""}</td>
          <td>${w.published_at ? formatUK(w.published_at) : ""}</td>
          <td>
            <button class="btn btn-sm btn-open-week" data-id="${w.id}">Open</button>
          </td>
        `;
        weeksTbody.appendChild(tr);
      }

      document.querySelectorAll(".btn-open-week").forEach(btn => {
        btn.addEventListener("click", async () => {
          const id = btn.getAttribute("data-id");
          const { data, error } = await supabase
            .from("roster_weeks")
            .select("*")
            .eq("id", id)
            .single();

          if (error) {
            console.error(error);
            return;
          }
          await openWeek(data);
        });
      });
    }

    async function openWeek(weekRow) {
      currentWeek = weekRow;
      editorCard.classList.remove("hidden");
      editorTitle.textContent = `Week ending ${formatUK(weekRow.week_ending)}`;
      editorSubtitle.textContent = weekRow.label || "";
      setStatusPill(weekRow.status);
      renderRosterGrid(weekRow.data);
      syncEditorButtons();
    }

    function setStatusPill(status) {
      editorStatusPill.textContent = status;
      editorStatusPill.classList.remove("status-draft", "status-published");
      editorStatusPill.classList.add(status === "published" ? "status-published" : "status-draft");
    }

    function syncEditorButtons() {
      const role = currentProfile?.role || "viewer";
      const isEditor = role === "editor" || role === "admin";
      const isDraft = currentWeek?.status === "draft";

      if (isPublicViewer || role === "viewer") {
        btnSaveWeek.disabled = true;
        btnPublishWeek.disabled = true;
        btnPublishWeek.textContent = "Publish";
        return;
      }

      btnSaveWeek.disabled = !(isEditor && isDraft);
      btnPublishWeek.disabled = !isEditor;
      btnPublishWeek.textContent = isDraft ? "Publish" : "Re-publish";
    }

    function classifyShift(value) {
      const classes = [];
      if (!value) return "";

      const v = String(value).trim().toUpperCase();

      // Day shifts
      if (v === "0600-1800" || v === "0700-1900" || v === "0630-1830") {
        classes.push("shift-day");
      }

      // Night shifts
      if (v === "1800-0600" || v === "1830-0630") {
        classes.push("shift-night");
      }

      // Spare
      if (v.includes("SPARE")) {
        classes.push("shift-spare");
      }

      // N/A
      if (v === "N/A") {
        classes.push("shift-oo");
      }

      // Annual leave
      if (v.includes("A/L")) {
        classes.push("shift-al");
      }

      // Comp leave
      if (v.includes("C/L")) {
        classes.push("shift-cl");
      }

      // Sick
      if (v.includes("SICK") || v.includes("S/L")) {
        classes.push("shift-sick");
      }

      // Rest day
      if (v === "RD") {
        classes.push("shift-rd");
      }

      // B.O mirrors A/L styling
      if (v.includes("B.O")) {
        classes.push("shift-al");
      }

      // LROP / HROP bold
      if (v.includes("LROP") || v.includes("HROP")) {
        classes.push("shift-rop");
      }

      return classes.join(" ");
    }

    function renderRosterGrid(data) {
      rosterGrid.innerHTML = "";

      if (!data || !Array.isArray(data.sections)) {
        rosterGrid.innerHTML = "<p class='muted'>No sections defined in this roster.</p>";
        return;
      }

      const role = currentProfile?.role || "viewer";
      const readOnly = isPublicViewer || role === "viewer";

      data.sections.forEach(section => {
        const sectionDiv = document.createElement("div");
        sectionDiv.classList.add("mt-3");

        const headerDiv = document.createElement("div");
        headerDiv.classList.add("flex-between", "mb-1");
        headerDiv.innerHTML = `
          <div class="flex">
            <h3 style="margin:0;font-size:0.95rem;color:#0f172a;">${section.title || "Section"}</h3>
            ${section.note ? `<span class="tag">${section.note}</span>` : ""}
          </div>
        `;
        sectionDiv.appendChild(headerDiv);

        const table = document.createElement("table");
        const thead = document.createElement("thead");
        thead.innerHTML = `
          <tr>
            <th>Name</th>
            <th>Sun</th>
            <th>Mon</th>
            <th>Tue</th>
            <th>Wed</th>
            <th>Thu</th>
            <th>Fri</th>
            <th>Sat</th>
            <th>Remarks</th>
          </tr>
        `;
        table.appendChild(thead);

        const tbody = document.createElement("tbody");

        (section.rows || []).forEach((row, rowIndex) => {
          const tr = document.createElement("tr");

          function makeCell(key) {
            const td = document.createElement("td");
            const wrap = document.createElement("div");
            wrap.className = "shift-cell-wrap";

            const input = document.createElement("input");
            input.value = row.shifts?.[key] || "";
            input.dataset.sectionId = section.id;
            input.dataset.rowIndex = rowIndex;
            input.dataset.field = key;
            input.className = "shift-input " + classifyShift(input.value);

            const select = document.createElement("select");
            select.className = "shift-preset";
            const presetOptions = ["", "0600-1800", "1800-0600", "0700-1900", "0630-1830", "1830-0630"];
            presetOptions.forEach(val => {
              const opt = document.createElement("option");
              opt.value = val;
              opt.textContent = val || "⧉";
              select.appendChild(opt);
            });

            const rdwBtn = document.createElement("button");
            rdwBtn.type = "button";
            rdwBtn.textContent = "RDW";
            rdwBtn.className = "rdw-toggle";

            const rdwActive = row.rdw && row.rdw[key];
            if (rdwActive) {
              rdwBtn.classList.add("rdw-active");
            }

            const roleInner = currentProfile?.role || "viewer";
            const readOnlyInner = isPublicViewer || roleInner === "viewer";

            if (readOnlyInner) {
              input.disabled = true;
              select.disabled = true;
              select.style.display = "none";
              rdwBtn.disabled = true;
            } else {
              input.addEventListener("input", handleShiftChange);

              select.addEventListener("change", () => {
                if (!select.value) return;
                input.value = select.value;
                handleShiftChange({ target: input });
              });

              rdwBtn.addEventListener("click", () => {
                const sections = currentWeek.data.sections || [];
                const sec = sections.find(s => s.id === section.id);
                if (!sec) return;
                if (!sec.rows[rowIndex]) sec.rows[rowIndex] = {};
                if (!sec.rows[rowIndex].rdw) sec.rows[rowIndex].rdw = {};
                const current = !!sec.rows[rowIndex].rdw[key];
                sec.rows[rowIndex].rdw[key] = !current;
                rdwBtn.classList.toggle("rdw-active", !current);
              });
            }

            wrap.appendChild(input);
            wrap.appendChild(select);
            wrap.appendChild(rdwBtn);
            td.appendChild(wrap);
            return td;
          }

          const nameTd = document.createElement("td");
          const nameInput = document.createElement("input");
          nameInput.value = row.staff_name || "";
          nameInput.dataset.sectionId = section.id;
          nameInput.dataset.rowIndex = rowIndex;
          nameInput.dataset.field = "staff_name";

          if (readOnly) {
            nameInput.disabled = true;
          } else {
            nameInput.addEventListener("input", handleNameChange);
          }

          nameTd.appendChild(nameInput);
          tr.appendChild(nameTd);

          ["sun","mon","tue","wed","thu","fri","sat"].forEach(day => {
            tr.appendChild(makeCell(day));
          });

          const remarksTd = document.createElement("td");
          const remarksInput = document.createElement("input");
          remarksInput.value = row.remarks || "";
          remarksInput.dataset.sectionId = section.id;
          remarksInput.dataset.rowIndex = rowIndex;
          remarksInput.dataset.field = "remarks";

          if (readOnly) {
            remarksInput.disabled = true;
          } else {
            remarksInput.addEventListener("input", handleRemarksChange);
          }

          remarksTd.appendChild(remarksInput);
          tr.appendChild(remarksTd);

          tbody.appendChild(tr);
        });

        table.appendChild(tbody);
        sectionDiv.appendChild(table);
        rosterGrid.appendChild(sectionDiv);
      });
    }

    function handleNameChange(e) {
      const role = currentProfile?.role || "viewer";
      if (isPublicViewer || role === "viewer") return;

      const input = e.target;
      const sectionId = input.dataset.sectionId;
      const rowIndex = parseInt(input.dataset.rowIndex, 10);

      const sections = currentWeek.data.sections || [];
      const section = sections.find(s => s.id === sectionId);
      if (!section) return;

      if (!section.rows[rowIndex]) section.rows[rowIndex] = {};
      section.rows[rowIndex].staff_name = input.value;
    }

    function handleRemarksChange(e) {
      const role = currentProfile?.role || "viewer";
      if (isPublicViewer || role === "viewer") return;

      const input = e.target;
      const sectionId = input.dataset.sectionId;
      const rowIndex = parseInt(input.dataset.rowIndex, 10);

      const sections = currentWeek.data.sections || [];
      const section = sections.find(s => s.id === sectionId);
      if (!section) return;

      if (!section.rows[rowIndex]) section.rows[rowIndex] = {};
      section.rows[rowIndex].remarks = input.value;
    }

    function handleShiftChange(e) {
      const role = currentProfile?.role || "viewer";
      if (isPublicViewer || role === "viewer") return;

      const input = e.target;
      const sectionId = input.dataset.sectionId;
      const rowIndex = parseInt(input.dataset.rowIndex, 10);
      const field = input.dataset.field;

      const sections = currentWeek.data.sections || [];
      const section = sections.find(s => s.id === sectionId);
      if (!section) return;

      if (!section.rows[rowIndex]) section.rows[rowIndex] = { shifts: {} };
      if (!section.rows[rowIndex].shifts) section.rows[rowIndex].shifts = {};
      section.rows[rowIndex].shifts[field] = input.value;

      input.className = "shift-input " + classifyShift(input.value);
    }

    btnSaveWeek.addEventListener("click", async () => {
      if (!currentWeek) return;
      const role = currentProfile?.role || "viewer";
      if (isPublicViewer || role === "viewer") return;

      const { data, error } = await supabase
        .from("roster_weeks")
        .update({ data: currentWeek.data })
        .eq("id", currentWeek.id)
        .select("*")
        .single();

      if (error) {
        console.error(error);
        alert("Error saving week.");
        return;
      }
      currentWeek = data;
      alert("Draft saved.");
    });

    btnPublishWeek.addEventListener("click", async () => {
      if (!currentWeek) return;
      const role = currentProfile?.role || "viewer";
      if (isPublicViewer || role === "viewer") return;

      const { data, error } = await supabase
        .from("roster_weeks")
        .update({ status: "published", published_at: new Date().toISOString() })
        .eq("id", currentWeek.id)
        .select("*")
        .single();

      if (error) {
        console.error(error);
        alert("Error publishing week.");
        return;
      }

      currentWeek = data;
      setStatusPill("published");
      syncEditorButtons();
      await loadWeeks();
      alert("Week published.");
    });
  </script>
</body>
</html>
